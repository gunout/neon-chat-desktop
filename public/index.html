<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON-CHAT // CYBERPUNK 2077</title>
    <link href="https://fonts.cdnfonts.com/css/cyberpunk" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --neon-blue: #0ff0fc;
            --neon-pink: #ff00ff;
            --dark-bg: #0a0a12;
            --darker-bg: #050508;
            --text-glow: 0 0 10px currentColor;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cyber', 'Courier New', monospace;
            background-color: var(--dark-bg);
            color: var(--neon-blue);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 255, 0.05) 0%, transparent 25%),
                radial-gradient(circle at 80% 70%, rgba(0, 255, 252, 0.05) 0%, transparent 25%);
        }

        #cyber-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 20px var(--neon-blue);
        }

        /* Mode Desktop */
        @media (min-width: 768px) {
            #cyber-container {
                flex-direction: row;
                height: 100vh;
            }
            
            #connection-info {
                width: 220px;
                min-width: 220px;
                border-right: 1px solid var(--neon-pink);
            }
            
            #neon-video-wall {
                flex: 1;
                order: 2;
            }
            
            #cyber-sidepanel {
                width: 320px;
                min-width: 320px;
                order: 3;
                border-left: 1px solid var(--neon-pink);
            }

            #cyber-messages {
                max-height: calc(100vh - 400px); /* Réduit la hauteur des messages */
            }
            
            #cyber-user-list {
                max-height: 35vh; /* Augmente la hauteur de la liste utilisateurs */
                overflow-y: auto; /* Ajoute un scroll si nécessaire */
            }
        }

        /* Mode Mobile */
        @media (max-width: 767px) {
            #cyber-container {
                height: auto;
            }
            
            #neon-video-wall {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 8px;
                padding: 8px;
                border-bottom: 1px solid var(--neon-pink);
            }

            #connection-info {
                border-bottom: 1px solid var(--neon-pink);
            }
            
            #cyber-chat {
                height: auto;
                flex-grow: 1;
            }
            
            #cyber-messages {
                max-height: 30vh; /* Réduit la hauteur des messages */
            }
            
            #cyber-user-list {
                max-height: 25vh;
                overflow-y: auto; /* Ajoute un scroll si nécessaire */
            }
        }

        /* Panel d'information de connexion */
        #connection-info {
            background: var(--darker-bg);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #connection-status {
            padding: 10px;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--neon-blue);
            text-align: center;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .disconnected {
            border-color: #ff0000;
            color: #ff0000;
        }

        .connected {
            border-color: #00ff00;
            color: #00ff00;
        }

        .info-panel {
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--neon-blue);
            border-radius: 4px;
        }

        .info-label {
            color: var(--neon-pink);
            font-size: 0.8em;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            color: var(--neon-blue);
            font-size: 1em;
            word-break: break-word;
            text-shadow: var(--text-glow);
        }

        /* Zone vidéo */
        #neon-video-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            background-color: var(--darker-bg);
            flex: 1;
            min-height: 200px;
        }

        .cyber-video {
            position: relative;
            border: 2px solid var(--neon-blue);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 10px var(--neon-blue);
            transition: all 0.3s;
            background: black;
            aspect-ratio: 16/9;
        }

        .cyber-video:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px var(--neon-pink);
            border-color: var(--neon-pink);
        }

        .cyber-video video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 6px;
            font-size: 12px;
            color: var(--neon-pink);
            text-shadow: var(--text-glow);
            border-top: 1px solid var(--neon-pink);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Panel droit */
        #cyber-sidepanel {
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom, #0f0f1a, #05050a);
            height: 100%;
        }

        /* Contrôles de salle */
        #room-controls {
            display: flex;
            padding: 10px;
            background: var(--darker-bg);
            border-bottom: 1px solid var(--neon-pink);
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }

        .room-tab {
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            cursor: pointer;
            font-size: 0.8em;
            flex-grow: 1;
            text-align: center;
            min-width: 60px;
        }

        .room-tab.active {
            background: rgba(0, 240, 252, 0.1);
            border-color: var(--neon-pink);
            color: var(--neon-pink);
        }

        #new-room-input {
            flex: 2;
            min-width: 100px;
        }

        #create-room-btn {
            min-width: 40px;
        }

        /* Liste utilisateurs */
        #cyber-user-list {
            padding: 12px;
            border-bottom: 1px solid var(--neon-blue);
        }

        #cyber-user-list h3 {
            color: var(--neon-pink);
            text-shadow: 0 0 10px var(--neon-pink);
            margin-top: 0;
            border-bottom: 1px solid var(--neon-pink);
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .cyber-user {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(15, 15, 25, 0.5);
            border-left: 3px solid var(--neon-blue);
            color: white;
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        .cyber-user::before {
            content: ">";
            color: var(--neon-pink);
            margin-right: 8px;
        }

        .user-status {
            margin-left: auto;
            font-size: 1em;
        }

        .stream-indicator {
            margin-left: 5px;
        }

        /* Zone de chat */
        #cyber-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        #cyber-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-blue);
            box-shadow: inset 0 0 8px rgba(0, 255, 252, 0.2);
            font-size: 0.9em;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-blue) var(--darker-bg);
        }

        #cyber-messages::-webkit-scrollbar {
            width: 6px;
        }

        #cyber-messages::-webkit-scrollbar-track {
            background: var(--darker-bg);
            border-radius: 3px;
        }

        #cyber-messages::-webkit-scrollbar-thumb {
            background-color: var(--neon-blue);
            border-radius: 3px;
            border: 1px solid var(--neon-pink);
        }

        #cyber-messages::-webkit-scrollbar-thumb:hover {
            background-color: var(--neon-pink);
        }

        .cyber-message {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px dashed rgba(255, 0, 255, 0.3);
            word-break: break-word;
        }

        .cyber-message strong {
            color: var(--neon-pink);
            text-shadow: var(--text-glow);
            font-size: 0.95em;
        }

        .cyber-message small {
            display: block;
            color: var(--neon-blue);
            font-size: 0.75em;
            margin-top: 3px;
        }

        /* Contrôles */
        #cyber-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 10px;
            background: rgba(5, 5, 10, 0.8);
            border-top: 1px solid var(--neon-pink);
        }

        @media (max-width: 480px) {
            #cyber-controls {
                grid-template-columns: 1fr;
            }
        }

        #cyber-message-input {
            grid-column: span 2;
        }

        @media (max-width: 480px) {
            #cyber-message-input {
                grid-column: span 1;
            }
        }

        .cyber-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 8px;
            font-family: 'Cyber', monospace;
            outline: none;
            font-size: 0.9em;
            width: 100%;
        }

        .cyber-input:focus {
            border-color: var(--neon-pink);
            box-shadow: 0 0 8px var(--neon-pink);
        }

        .cyber-btn {
            background: linear-gradient(to bottom, #0a0a20, #00001a);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 8px;
            font-family: 'Cyber', monospace;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            font-size: 0.8em;
            text-align: center;
        }

        .cyber-btn:hover {
            color: var(--neon-pink);
            border-color: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink);
            text-shadow: var(--text-glow);
        }

        .cyber-btn::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                transparent 45%,
                var(--neon-blue) 50%,
                transparent 55%
            );
            transform: rotate(45deg);
            opacity: 0;
            transition: all 0.5s;
        }

        .cyber-btn:hover::before {
            opacity: 0.5;
            animation: shine 1.5s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        /* Barres de défilement */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-blue);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-pink);
        }

        /* Effets globaux */
        .glow {
            text-shadow: 0 0 5px currentColor;
        }

        .pink-glow {
            color: var(--neon-pink);
            text-shadow: 0 0 8px var(--neon-pink);
        }

        .blue-glow {
            color: var(--neon-blue);
            text-shadow: 0 0 8px var(--neon-blue);
        }

        /* Animation du titre */
        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
                opacity: 1;
            }
            20%, 22%, 24%, 55% {
                opacity: 0.5;
            }
        }

        h1 {
            position: fixed;
            top: 10px;
            left: 10px;
            margin: 0;
            font-size: 18px;
            animation: flicker 3s infinite;
            z-index: 100;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 20px;
            }
        }

        /* Authentification */
        #cyber-auth {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-box {
            background: var(--darker-bg);
            padding: 1.5rem;
            border: 1px solid var(--neon-pink);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        /* Émoticônes */
        #emote-picker {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--darker-bg);
            border: 1px solid var(--neon-pink);
            padding: 8px;
            display: none;
            flex-wrap: wrap;
            width: 180px;
            z-index: 100;
            gap: 5px;
        }

        @media (min-width: 768px) {
            #emote-picker {
                bottom: 80px;
                right: 20px;
                width: 200px;
            }
        }

        .emote-option {
            padding: 5px;
            border: 1px solid var(--neon-blue);
            cursor: pointer;
            flex: 1 0 40%;
            text-align: center;
            font-size: 0.9em;
        }

        .emote-option:hover {
            background: rgba(0, 240, 252, 0.1);
        }

        /* Mode plein écran pour les vidéos */
        .video-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-fullscreen video {
            max-width: 100%;
            max-height: 100%;
        }

        .close-fullscreen {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--neon-pink);
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Lecteur Radio */
        #cyber-radio {
            border-color: var(--neon-pink);
            margin-bottom: 15px;
        }

        #radio-controls {
            display: flex;
            flex-direction: column;
        }

        #radio-status.playing {
            color: var(--neon-pink);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; text-shadow: 0 0 10px var(--neon-pink); }
            100% { opacity: 0.6; }
        }

        /* Bouton Retour en haut */
        #cyber-back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--darker-bg);
            border: 2px solid var(--neon-pink);
            color: var(--neon-blue);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            z-index: 99;
            box-shadow: 0 0 10px var(--neon-pink);
            font-family: 'Cyber', monospace;
            font-size: 1.5em;
        }

        #cyber-back-to-top.visible {
            opacity: 1;
        }

        #cyber-back-to-top:hover {
            background: var(--neon-pink);
            color: black;
            box-shadow: 0 0 15px var(--neon-pink);
            transform: translateY(-3px);
        }

        /* Styles pour le système d'appel */
        #call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #call-user-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        #call-user-list .cyber-user {
            cursor: pointer;
            margin: 5px 0;
        }

        #call-user-list .cyber-user.selected {
            border-color: var(--neon-pink);
            background: rgba(255, 0, 255, 0.1);
        }

        /* Nouveaux styles pour l'appel vidéo */
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker-bg);
            z-index: 1001;
            display: none;
            flex-direction: column;
            padding: 20px;
        }

        .call-videos {
            display: flex;
            flex: 1;
            gap: 10px;
            margin-bottom: 10px;
        }

        .call-local-video, .call-remote-video {
            flex: 1;
            min-width: 0;
            border: 2px solid var(--neon-pink);
            border-radius: 4px;
            position: relative;
            background: black;
        }

        .call-local-video video, .call-remote-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .call-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 6px;
            font-size: 12px;
            color: var(--neon-pink);
            text-shadow: var(--text-glow);
            border-top: 1px solid var(--neon-pink);
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--neon-blue);
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }

        .call-btn:hover {
            border-color: var(--neon-pink);
            box-shadow: 0 0 15px var(--neon-pink);
        }

        .call-btn.end-call {
            border-color: #ff0000;
            color: #ff0000;
        }

        .call-btn.end-call:hover {
            background: #ff0000;
            color: white;
        }

        /* Nouveaux styles pour le lecteur central */
        #central-controls {
            display: flex;
            flex-direction: column;
            background: var(--darker-bg);
            padding: 15px;
            border-bottom: 1px solid var(--neon-pink);
        }

        #media-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        #m3u-controls {
            display: flex;
            flex-direction: column;
        }

        /* Ajustement de la disposition principale */
        #cyber-container {
            display: grid;
            grid-template-columns: 220px 1fr 320px;
            min-height: 100vh;
        }

        @media (max-width: 1200px) {
            #cyber-container {
                grid-template-columns: 180px 1fr 280px;
            }
        }

        @media (max-width: 992px) {
            #cyber-container {
                grid-template-columns: 150px 1fr;
            }
            #cyber-sidepanel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            #cyber-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            #connection-info {
                order: 1;
            }
            #central-panel {
                order: 2;
            }
            #cyber-sidepanel {
                order: 3;
                display: block;
            }
        }
    </style>
</head>
<body>
    <div id="cyber-auth">
        <div class="auth-box">
            <h2 class="pink-glow" style="text-align: center;">ENTER</h2>
            <input type="text" id="auth-username" class="cyber-input" placeholder="PSEUDO" style="width: 100%; margin: 1rem 0;">
            <button id="auth-submit" class="cyber-btn" style="width: 100%;">CONNEXION</button>
        </div>
    </div>

    <h1 class="pink-glow">// C R E W</h1>
    
    <div id="cyber-container" style="display: none;">   
    
        <!-- Panel gauche (inchangé) -->
         <!-- Panel d'information de connexion à gauche -->
        <div id="connection-info">
            <div id="connection-status" class="disconnected">DÉCONNECTÉ</div>
            <div class="info-panel">
                <div class="info-label">UTILISATEUR</div>
                <div id="username-display" class="info-value">-</div>
            </div>
            <div class="info-panel">
                <div class="info-label">SALLE ACTUELLE</div>
                <div id="room-display" class="info-value">-</div>
            </div>
            <div class="info-panel">
                <div class="info-label">ID DE CONNEXION</div>
                <div id="userid-display" class="info-value">-</div>
            </div>
            
            <!-- Panel Radio -->
            <div id="cyber-radio" class="info-panel" style="margin-top: auto; display: none;">
                <div class="info-label">RADIO CYBERPUNK</div>
                <div id="radio-controls">
                    <select id="radio-station" class="cyber-input" style="margin-bottom: 10px;">
                        <option value="">-- Sélectionnez une station --</option>
                        <option value="https://gleaphe.duckdns.org/stream">Gleaphe radio</option>
                        <option value="https://guyane.ice.infomaniak.ch/guyane-128.mp3">Guyane 1ere</option>
                        <option value="https://guadeloupe.ice.infomaniak.ch/guadeloupe-128.mp3">Guadeloupe 1ere</option>
                        <option value="https://martinique.ice.infomaniak.ch/martinique-128.mp3">Martinique 1ere</option>
                        <option value="https://reunion.ice.infomaniak.ch/reunion-128.mp3">Reunion 1ere</option>
                        <option value="https://mayotte.ice.infomaniak.ch/mayotte-128.mp3">Mayotte 1ere</option>
                        <option value="https://polynesie.ice.infomaniak.ch/polynesie-128.mp3">Polynesie 1ere</option>
                    	<option value="https://wallisetfutuna.ice.infomaniak.ch/wallisetfutuna-128.mp3">Wallis et Futuna 1ere</option>
                        <option value="https://saint-pierreetmiquelon.ice.infomaniak.ch/saint-pierreetmiquelon-128.mp3">St Pierre et Miquelon 1ere</option>
                        <option value="https://nouvelle-caledonie.ice.infomaniak.ch/nouvelle-caledonie-128.mp3">Nouvelle Caledonie 1ere</option>
                        <option value="https://outremer.ice.infomaniak.ch/outremer-128.mp3">Outremer 1ere</option>
                     	<option value="https://exofmreunion.ice.infomaniak.ch/exofmreunion-64.aac">Exo Fm</option>
                        <option value="http://freedomice.streamakaci.com/freedom.mp3">Freedom</option>
                        <option value="http://freedomice.streamakaci.com/freedom2.mp3">Freedom 2</option>
                        <option value="http://kreolfm.ice.infomaniak.ch/kreolfm-96.aac">Kreol Fm</option>
                    	<option value="http://neofming.streamakaci.com/neofm.mp3">Neo Fm</option>
                        <option value="http://icecast.skyrock.net/s/natio_mp3_128k">Skyrock</option>
                        <option value="https://listen.radioking.com/radio/400111/stream/452236">Urban Hit Re</option>
                        <option value="https://stream4.vestaradio.com/RADIOPIKAN?nocache=89908">Radio Pikan</option>
		</select>
                    <div style="display: flex; gap: 5px;">
                        <button id="radio-play" class="cyber-btn" style="flex: 1;">▶ PLAY</button>
                        <button id="radio-stop" class="cyber-btn" style="flex: 1;">■ STOP</button>
                    </div>
                    <audio id="radio-player" hidden></audio>
                </div>
                <div id="radio-status" class="info-value" style="margin-top: 10px; font-size: 0.8em;">Prêt</div>
            </div>
        </div>
	
        <!-- Nouveau panel central -->
        <div id="central-panel">
            <!-- Contrôles média -->
            <div id="central-controls">
                <div id="media-controls">
                    <button id="cyber-cam-btn" class="cyber-btn">CAMÉRA</button>
                    <button id="cyber-screen-btn" class="cyber-btn">ÉCRAN</button>
                    <button id="cyber-emote-btn" class="cyber-btn">ÉMOTES</button>
                    <button id="cyber-call-btn" class="cyber-btn">APPEL VIDÉO</button>
                </div>

                <!-- Lecteur M3U intégré -->
                <div id="m3u-controls" class="info-panel">
                    <div class="info-label">LECTEUR FLUX M3U/M3U8</div>
                    <input type="text" id="m3u-url" class="cyber-input" placeholder="URL du flux .m3u/.m3u8" style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 5px;">
                        <button id="m3u-play" class="cyber-btn" style="flex: 1;">▶ LIRE</button>
                        <button id="m3u-stop" class="cyber-btn" style="flex: 1;">■ STOP</button>
                    </div>
                    <div id="m3u-status" class="info-value" style="margin-top: 10px; font-size: 0.8em;">Prêt</div>
                </div>
            </div>

            <!-- Mur vidéo (inchangé) -->
            <div id="neon-video-wall">
                <div id="m3u-player-container" class="cyber-video" style="display: none;">
                    <video id="m3u-player" autoplay playsinline></video>
                    <div class="video-label">FLUX M3U</div>
                </div>
            </div>
        </div>

        <!-- Panel droit (inchangé) -->
        <!-- Panel droit -->
        <div id="cyber-sidepanel">
            <!-- Contrôles de salle -->
            <div id="room-controls">
                <div class="room-tab active" data-room="main">GÉNÉRAL</div>
                <div class="room-tab" data-room="crew">CREW</div>
                <input type="text" id="new-room-input" class="cyber-input" placeholder="NOUVELLE SALLE">
                <button id="create-room-btn" class="cyber-btn">+</button>
            </div>

            <!-- Liste utilisateurs -->
            <div id="cyber-user-list">
                <h3 class="glow">>_UTILISATEURS_CONNECTÉS</h3>
                <div id="user-list"></div>
            </div>

            <!-- Chat -->
            <div id="cyber-chat">
                <div id="cyber-messages"></div>

                <!-- Contrôles -->
                <div id="cyber-controls">
    <input type="text" id="cyber-message-input" class="cyber-input" placeholder="ENTRER_MESSAGE...">
    <button id="cyber-send-btn" class="cyber-btn">ENVOYER</button>
    <button id="cyber-endcall-btn" class="cyber-btn" style="display: none;">TERMINER</button>
</div>
            </div>
        </div>
    </div>

    <!-- Sélecteur d'émoticônes -->
    <div id="emote-picker">
        <div class="emote-option" data-emote="⌇">⌇ Déconnexion</div>
        <div class="emote-option" data-emote="⍟">⍟ Étoile</div>
        <div class="emote-option" data-emote="⊛">⊛ Cible</div>
        <div class="emote-option" data-emote="⟁">⟁ Diamant</div>
        <div class="emote-option" data-emote="⍎">⍎ Données</div>
        <div class="emote-option" data-emote="⚡">⚡ Éclair</div>
        <div class="emote-option" data-emote="☠">☠ Danger</div>
        <div class="emote-option" data-emote="⟐">⟐ Cercle</div>
    </div>

    <!-- Modal d'appel vidéo -->
    <div id="call-modal">
        <div class="auth-box">
            <h3 class="pink-glow">SÉLECTIONNER UN UTILISATEUR</h3>
            <div id="call-user-list"></div>
            <button id="call-start-btn" class="cyber-btn">DÉMARRER L'APPEL</button>
            <button id="call-cancel-btn" class="cyber-btn" style="margin-top: 10px;">ANNULER</button>
        </div>
    </div>

    <!-- Conteneur d'appel vidéo -->
    <div id="call-container" class="call-container">
        <div class="call-videos">
            <div class="call-local-video">
                <video id="local-call-video" autoplay playsinline></video>
                <div class="call-label">Vous</div>
            </div>
            <div class="call-remote-video">
                <video id="remote-call-video" autoplay playsinline></video>
                <div class="call-label" id="remote-call-label">Appel avec <span id="call-username"></span></div>
            </div>
        </div>
        <div class="call-controls">
            <div class="call-btn" id="toggle-mic-btn">🎤</div>
            <div class="call-btn" id="toggle-cam-btn">📷</div>
            <div class="call-btn end-call" id="end-call-btn">✖</div>
        </div>
    </div>

    <!-- Bouton Retour en haut -->
    <button id="cyber-back-to-top" title="Retour en haut">↑</button>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Configuration initiale
            const userId = generateUserId();
            let username = localStorage.getItem('username') || '';
            let currentRoom = 'main';
            let authToken = null;
            let websocket;
            let peerConnections = {};
            const localStreams = {};
            const remoteStreams = {};
            const configuration = {
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    { urls: "stun:stun1.l.google.com:19302" },
                    { urls: "stun:stun2.l.google.com:19302" },
                    { 
                        urls: "turn:numb.viagenie.ca",
                        username: "webrtc@live.com",
                        credential: "muazkh"
                    }
                ],
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require',
                iceCandidatePoolSize: 0
            };

            // Éléments DOM
            const authSection = document.getElementById('cyber-auth');
            const authUsername = document.getElementById('auth-username');
            const authSubmit = document.getElementById('auth-submit');
            const container = document.getElementById('cyber-container');
            const messageInput = document.getElementById('cyber-message-input');
            const sendBtn = document.getElementById('cyber-send-btn');
            const camBtn = document.getElementById('cyber-cam-btn');
            const screenBtn = document.getElementById('cyber-screen-btn');
            const emoteBtn = document.getElementById('cyber-emote-btn');
            const callBtn = document.getElementById('cyber-call-btn');
            const endCallBtn = document.getElementById('cyber-endcall-btn');
            const messagesContainer = document.getElementById('cyber-messages');
            const userListContainer = document.getElementById('user-list');
            const videoWall = document.getElementById('neon-video-wall');
            const emotePicker = document.getElementById('emote-picker');
            const callModal = document.getElementById('call-modal');
            const callUserList = document.getElementById('call-user-list');
            const callStartBtn = document.getElementById('call-start-btn');
            const callCancelBtn = document.getElementById('call-cancel-btn');
            const roomTabs = document.querySelectorAll('.room-tab');
            const newRoomInput = document.getElementById('new-room-input');
            const createRoomBtn = document.getElementById('create-room-btn');
            const connectionStatus = document.getElementById('connection-status');
            const usernameDisplay = document.getElementById('username-display');
            const roomDisplay = document.getElementById('room-display');
            const useridDisplay = document.getElementById('userid-display');
            const backToTopButton = document.getElementById('cyber-back-to-top');
            const radioPanel = document.getElementById('cyber-radio');
            const radioStation = document.getElementById('radio-station');
            const radioPlayBtn = document.getElementById('radio-play');
            const radioStopBtn = document.getElementById('radio-stop');
            const radioPlayer = document.getElementById('radio-player');
            const radioStatus = document.getElementById('radio-status');
            
            // Éléments pour le lecteur M3U
            const m3uUrlInput = document.getElementById('m3u-url');
            const m3uPlayBtn = document.getElementById('m3u-play');
            const m3uStopBtn = document.getElementById('m3u-stop');
            const m3uStatus = document.getElementById('m3u-status');
            const m3uPlayer = document.getElementById('m3u-player');
            const m3uPlayerContainer = document.getElementById('m3u-player-container');
            let hls = null;

            // Variables pour la gestion des appels
            let callInProgress = false;
            let callTarget = null;
            let callStream = null;
            let localCallVideo = document.getElementById('local-call-video');
            let remoteCallVideo = document.getElementById('remote-call-video');
            let callContainer = document.getElementById('call-container');
            let callUsername = document.getElementById('call-username');
            let endCallButton = document.getElementById('end-call-btn');
            let toggleMicBtn = document.getElementById('toggle-mic-btn');
            let toggleCamBtn = document.getElementById('toggle-cam-btn');
            let micEnabled = true;
            let camEnabled = true;

            // Mettre à jour les infos de connexion
            function updateConnectionInfo() {
                usernameDisplay.textContent = username || '-';
                roomDisplay.textContent = currentRoom || '-';
                useridDisplay.textContent = userId.slice(0, 8) + '...';
            }

            // Générer un ID utilisateur
            function generateUserId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Vérifier les permissions média
            async function checkMediaPermissions() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const hasVideoPermission = devices.some(device => device.kind === 'videoinput' && device.label);
                    
                    if (!hasVideoPermission) {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Erreur vérification permissions:', error);
                    return false;
                }
            }

            // Vérifie les permissions et les capacités
            async function checkMediaCapabilities() {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error("L'API MediaDevices n'est pas disponible");
                    }

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const hasCamera = devices.some(device => device.kind === 'videoinput');
                    
                    if (!hasCamera) {
                        throw new Error("Aucune caméra détectée");
                    }

                    // Teste réellement l'accès à la caméra
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true,
                        audio: true 
                    });
                    
                    // Libère les ressources
                    stream.getTracks().forEach(track => track.stop());
                    
                    return true;
                } catch (error) {
                    console.error("Erreur vérification média:", error);
                    alert(`ERREUR CAMÉRA: ${error.message}`);
                    return false;
                }
            }

            // Gestion du bouton Retour en haut
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            });

            backToTopButton.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // Gestion du double scroll
            messagesContainer.addEventListener('wheel', (e) => {
                const isScrollingUp = e.deltaY < 0;
                const isAtTop = messagesContainer.scrollTop === 0;
                const isAtBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight - messagesContainer.scrollTop < 1;

                if ((isScrollingUp && isAtTop) || (!isScrollingUp && isAtBottom)) {
                    return;
                }
                
                e.stopPropagation();
            });

            function adjustMessagesHeight() {
                if (window.innerWidth < 768) {
                    const containerHeight = window.innerHeight;
                    const controlsHeight = document.getElementById('cyber-controls').offsetHeight;
                    const headerHeight = document.getElementById('cyber-user-list').offsetHeight;
                    messagesContainer.style.maxHeight = `${containerHeight - controlsHeight - headerHeight - 100}px`;
                }
            }

            window.addEventListener('resize', adjustMessagesHeight);
            adjustMessagesHeight();

            // Authentification
            if (username) {
                authUsername.value = username;
                const hasPermissions = await checkMediaPermissions();
                if (!hasPermissions) {
                    alert("L'application nécessite l'accès à la caméra pour fonctionner complètement.");
                }
                container.style.display = 'flex';
                updateConnectionInfo();
                await initWebSocket();
            } else {
                authSection.style.display = 'flex';
            }

            authSubmit.addEventListener('click', async () => {
                username = authUsername.value.trim();
                if (username) {
                    const hasPermissions = await checkMediaCapabilities();
                    if (!hasPermissions) {
                        return;
                    }

                    localStorage.setItem('username', username);
                    authSection.style.display = 'none';
                    container.style.display = 'flex';
                    updateConnectionInfo();
                    await initWebSocket();
                }
            });

            // Gestion de la caméra
            async function toggleCamera() {
                if (localStreams['camera']) {
                    stopStream('camera');
                    camBtn.textContent = 'CAMÉRA';
                    return;
                }

                try {
                    // Configuration optimisée pour mobile/desktop
                    const constraints = {
                        video: {
                            width: { 
                                ideal: window.innerWidth < 768 ? 640 : 1280,
                                max: window.innerWidth < 768 ? 1280 : 1920
                            },
                            height: { 
                                ideal: window.innerWidth < 768 ? 480 : 720,
                                max: window.innerWidth < 768 ? 720 : 1080
                            },
                            facingMode: 'user',
                            frameRate: { ideal: 24, max: 30 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints)
                        .catch(err => {
                            console.error("Erreur getUserMedia:", err);
                            throw err;
                        });

                    // Vérification que la track vidéo est bien active
                    const videoTrack = stream.getVideoTracks()[0];
                    if (!videoTrack || videoTrack.readyState !== 'live') {
                        throw new Error("La piste vidéo n'est pas active");
                    }

                    localStreams['camera'] = stream;
                    addLocalVideo(stream, 'camera');
                    camBtn.textContent = 'ARRÊTER CAM';

                    // Envoi des métadonnées importantes
                    const capabilities = {
                        width: videoTrack.getSettings().width,
                        height: videoTrack.getSettings().height,
                        frameRate: videoTrack.getSettings().frameRate,
                        deviceId: videoTrack.getSettings().deviceId
                    };

                    websocket.send(JSON.stringify({
                        type: 'stream_start',
                        data: { 
                            type: 'camera',
                            capabilities: capabilities
                        }
                    }));

                    initPeerConnections();

                    // Gestion de la fin de stream
                    videoTrack.onended = () => {
                        stopStream('camera');
                        camBtn.textContent = 'CAMÉRA';
                    };

                } catch (error) {
                    console.error("Erreur activation caméra:", error);
                    alert(`ERREUR: ${error.message}`);
                    camBtn.textContent = 'CAMÉRA';
                    
                    // Nettoyage en cas d'erreur
                    if (localStreams['camera']) {
                        stopStream('camera');
                    }
                }
            }

            // Gestion du partage d'écran
            async function toggleScreenShare() {
                if (localStreams['screen']) {
                    stopStream('screen');
                    screenBtn.textContent = 'ÉCRAN';
                } else {
                    try {
                        if (window.matchMedia('(max-width: 767px)').matches && !navigator.mediaDevices.getDisplayMedia) {
                            alert('Le partage d\'écran n\'est pas supporté sur votre appareil');
                            return;
                        }

                        const stream = await navigator.mediaDevices.getDisplayMedia({ 
                            video: { cursor: "always" },
                            audio: true 
                        });
                        localStreams['screen'] = stream;
                        addLocalVideo(stream, 'screen');
                        screenBtn.textContent = 'ARRÊTER';
                        
                        websocket.send(JSON.stringify({
                            type: 'stream_start',
                            data: { type: 'screen' }
                        }));
                        
                        initPeerConnections();
                        
                        stream.getVideoTracks()[0].onended = () => {
                            stopStream('screen');
                            screenBtn.textContent = 'ÉCRAN';
                        };
                    } catch (error) {
                        console.error('Erreur partage écran:', error);
                    }
                }
            }

            // Arrêter un stream
            function stopStream(type) {
                if (localStreams[type]) {
                    localStreams[type].getTracks().forEach(track => track.stop());
                    delete localStreams[type];
                    removeLocalVideo(type);
                    
                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                        websocket.send(JSON.stringify({
                            type: 'stream_stop',
                            data: { type }
                        }));
                    }
                    
                    Object.keys(peerConnections).forEach(userId => {
                        if (peerConnections[userId]) {
                            peerConnections[userId].close();
                        }
                        delete peerConnections[userId];
                        removeRemoteVideo(userId);
                    });
                }
            }

            // Ajouter une vidéo locale
            function addLocalVideo(stream, type) {
                removeLocalVideo(type);
                
                const videoContainer = document.createElement('div');
                videoContainer.className = 'cyber-video';
                videoContainer.id = `local-${type}`;
                
                const videoElement = document.createElement('video');
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                videoElement.srcObject = stream;
                
                const labelElement = document.createElement('div');
                labelElement.className = 'video-label';
                labelElement.classList.add(type === 'camera' ? 'pink-glow' : 'blue-glow');
                labelElement.textContent = `${username} [${type === 'camera' ? 'CAM' : 'SCREEN'}]`;
                
                const fullscreenBtn = document.createElement('div');
                fullscreenBtn.textContent = '⛶';
                fullscreenBtn.style.position = 'absolute';
                fullscreenBtn.style.top = '5px';
                fullscreenBtn.style.right = '5px';
                fullscreenBtn.style.cursor = 'pointer';
                fullscreenBtn.style.zIndex = '10';
                fullscreenBtn.style.backgroundColor = 'rgba(255,255,255,0.5)';
                fullscreenBtn.style.padding = '2px 5px';
                fullscreenBtn.style.borderRadius = '3px';
                fullscreenBtn.addEventListener('click', () => toggleFullscreen(videoElement, type));
                
                videoContainer.appendChild(videoElement);
                videoContainer.appendChild(labelElement);
                videoContainer.appendChild(fullscreenBtn);
                videoWall.appendChild(videoContainer);
            }

            // Basculer en plein écran
            function toggleFullscreen(videoElement, type) {
                const fullscreenContainer = document.createElement('div');
                fullscreenContainer.className = 'video-fullscreen';
                
                const clonedVideo = videoElement.cloneNode(true);
                clonedVideo.style.maxWidth = '90%';
                clonedVideo.style.maxHeight = '90%';
                
                const closeBtn = document.createElement('div');
                closeBtn.className = 'close-fullscreen';
                closeBtn.textContent = 'Fermer (ESC)';
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(fullscreenContainer);
                });
                
                fullscreenContainer.appendChild(clonedVideo);
                fullscreenContainer.appendChild(closeBtn);
                document.body.appendChild(fullscreenContainer);
                
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(fullscreenContainer);
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                
                document.addEventListener('keydown', handleKeyDown);
            }

            // Supprimer une vidéo locale
            function removeLocalVideo(type) {
                const existingVideo = document.getElementById(`local-${type}`);
                if (existingVideo) {
                    existingVideo.remove();
                }
            }

            // Initialiser WebSocket
            async function initWebSocket() {
                try {
                    const response = await fetch('/auth', {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Basic ' + btoa('admin:cyberpunk')
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Échec de l\'authentification');
                    }
                    
                    const data = await response.json();
                    authToken = data.token;
                    
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    websocket = new WebSocket(`${protocol}//${host}/ws/${userId}?token=${authToken}`);

                    websocket.onopen = () => {
                        console.log('WebSocket connecté');
                        connectionStatus.textContent = 'CONNECTÉ';
                        connectionStatus.classList.remove('disconnected');
                        connectionStatus.classList.add('connected');
                        
                        websocket.send(JSON.stringify({
                            type: 'register',
                            data: { username }
                        }));
                        
                        websocket.send(JSON.stringify({
                            type: 'join_room',
                            data: { room_id: currentRoom }
                        }));
                    };

                    websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    };

                    websocket.onclose = () => {
                        console.log('WebSocket déconnecté');
                        connectionStatus.textContent = 'DÉCONNECTÉ - Reconnexion...';
                        connectionStatus.classList.remove('connected');
                        connectionStatus.classList.add('disconnected');
                        setTimeout(initWebSocket, 5000);
                    };

                    websocket.onerror = (error) => {
                        console.error('Erreur WebSocket:', error);
                        connectionStatus.textContent = 'ERREUR DE CONNEXION';
                    };
                } catch (error) {
                    console.error('Erreur d\'initialisation:', error);
                    connectionStatus.textContent = 'ERREUR D\'AUTHENTIFICATION';
                    alert('Erreur de connexion au serveur');
                }
            }

            // Gérer les messages WebSocket
            function handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'user_list':
                        updateUserList(data.data);
                        break;
                    case 'new_message':
                        addMessage(data.data.user, data.data.text, data.data.time);
                        break;
                    case 'system_message':
                        addSystemMessage(data.data.message, data.data.time);
                        break;
                    case 'webrtc_signal':
                        handleWebRTCSignal(data.data.from, data.data.signal, data.data.type);
                        break;
                    case 'call_request':
                        handleIncomingCall(data.data.from, data.data.action);
                        break;
                    case 'call_response':
                        handleCallResponse(data.data.from, data.data.accepted, data.data.reason);
                        break;
                    default:
                        console.log('Message non géré:', data);
                }
            }

            // Mettre à jour la liste des utilisateurs
            function updateUserList(users) {
                userListContainer.innerHTML = '';
                const roomUsers = users.filter(user => user.current_room === currentRoom);
                
                if (roomUsers.length === 0) {
                    userListContainer.innerHTML = '<div class="cyber-user">Aucun utilisateur dans cette salle</div>';
                    return;
                }
                
                roomUsers.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'cyber-user';
                    userElement.classList.add(user.peer_id.slice(0, 1) % 2 === 0 ? 'blue-glow' : 'pink-glow');
                    userElement.textContent = user.username;
                    
                    const statusElement = document.createElement('span');
                    statusElement.className = 'user-status';
                    
                    if (user.streams.includes('camera')) {
                        statusElement.innerHTML += '<span class="stream-indicator">📹</span>';
                    }
                    if (user.streams.includes('screen')) {
                        statusElement.innerHTML += '<span class="stream-indicator">🖥️</span>';
                    }
                    
                    userElement.appendChild(statusElement);
                    userListContainer.appendChild(userElement);
                });
            }

            // Ajouter un message
            function addMessage(user, text, time) {
                const messageElement = document.createElement('div');
                messageElement.className = 'cyber-message';
                
                let formattedText = text;
                const emoteRegex = /(\[[^\]]+\])/g;
                formattedText = formattedText.replace(emoteRegex, '<span class="cyber-emote">$1</span>');
                
                messageElement.innerHTML = `
                    <strong class="pink-glow">${user}:</strong> 
                    <span>${formattedText}</span>
                    <small class="blue-glow">${time}</small>
                `;
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Ajouter un message système
            function addSystemMessage(message, time) {
                const messageElement = document.createElement('div');
                messageElement.className = 'cyber-message';
                messageElement.innerHTML = `
                    <strong class="pink-glow">SYSTEM:</strong> 
                    <span>${message}</span>
                    <small class="blue-glow">${time}</small>
                `;
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Initialiser les connexions peer
            async function initPeerConnections() {
                if (!websocket || websocket.readyState !== WebSocket.OPEN) return;
                
                websocket.send(JSON.stringify({
                    type: 'get_user_list',
                    data: {}
                }));
            }

            // Créer une connexion peer
            async function createPeerConnection(targetUserId) {
                if (peerConnections[targetUserId] || targetUserId === userId) return;
                
                console.log(`Création PeerConnection avec ${targetUserId}`);
                
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" },
                        { 
                            urls: "turn:numb.viagenie.ca",
                            username: "webrtc@live.com",
                            credential: "muazkh"
                        }
                    ],
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-bundle'
                });

                peerConnections[targetUserId] = pc;

                // Gestion ICE améliorée
                pc.onicecandidate = (event) => {
                    if (event.candidate && websocket.readyState === WebSocket.OPEN) {
                        console.log("Envoi ICE candidate à", targetUserId);
                        websocket.send(JSON.stringify({
                            type: "webrtc_signal",
                            data: {
                                target: targetUserId,
                                type: "candidate",
                                signal: event.candidate
                            }
                        }));
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`État ICE avec ${targetUserId}:`, pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed') {
                        console.log("Tentative de reconnection ICE...");
                        pc.restartIce();
                    }
                };

                // Réception des tracks distants
                pc.ontrack = (event) => {
                    console.log("Reçu track distant de", targetUserId);
                    if (!event.streams || event.streams.length === 0) {
                        console.warn("Aucun stream dans l'événement ontrack");
                        return;
                    }

                    const stream = event.streams[0];
                    const videoTracks = stream.getVideoTracks();
                    
                    if (videoTracks.length === 0) {
                        console.warn("Aucune piste vidéo dans le stream");
                        return;
                    }

                    if (callInProgress && targetUserId === callTarget) {
                        // Si c'est un appel en cours, afficher dans la fenêtre d'appel
                        remoteCallVideo.srcObject = stream;
                        remoteStreams[targetUserId] = stream;
                    } else {
                        // Sinon, afficher dans le mur vidéo normal
                        if (!remoteStreams[targetUserId]) {
                            remoteStreams[targetUserId] = stream;
                            addRemoteVideo(targetUserId, stream);
                        }
                    }
                };

                // Ajout des tracks locaux
                Object.values(localStreams).forEach(stream => {
                    stream.getTracks().forEach(track => {
                        console.log("Ajout track local:", track.kind);
                        pc.addTrack(track, stream);
                    });
                });

                // Création de l'offre
                try {
                    const offer = await pc.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    
                    await pc.setLocalDescription(offer);
                    
                    console.log("Envoi offre WebRTC à", targetUserId);
                    websocket.send(JSON.stringify({
                        type: "webrtc_signal",
                        data: {
                            target: targetUserId,
                            type: "offer",
                            signal: pc.localDescription
                        }
                    }));
                } catch (err) {
                    console.error('Erreur création offre:', err);
                }
                
                return pc;
            }

            // Gérer les signaux WebRTC
            async function handleWebRTCSignal(from, signal, type) {
                try {
                    console.log(`Reçu signal ${type} de ${from}`);
                    
                    if (from === userId) return;
                    
                    let pc = peerConnections[from];
                    
                    if (!pc) {
                        console.log(`Nouvelle PeerConnection pour ${from}`);
                        pc = await createPeerConnection(from);
                    }

                    switch (type) {
                        case 'offer':
                            console.log("Traitement offre de", from);
                            await pc.setRemoteDescription(new RTCSessionDescription(signal));
                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            
                            websocket.send(JSON.stringify({
                                type: "webrtc_signal",
                                data: {
                                    target: from,
                                    type: "answer",
                                    signal: pc.localDescription
                                }
                            }));
                            break;
                            
                        case 'answer':
                            console.log("Traitement réponse de", from);
                            await pc.setRemoteDescription(new RTCSessionDescription(signal));
                            break;
                            
                        case 'candidate':
                            try {
                                console.log("Ajout ICE candidate de", from);
                                await pc.addIceCandidate(new RTCIceCandidate(signal));
                            } catch (e) {
                                console.error('Erreur ajout ICE candidate:', e);
                            }
                            break;
                    }
                } catch (err) {
                    console.error('Erreur traitement signal WebRTC:', err);
                }
            }

            // Ajouter une vidéo distante
            function addRemoteVideo(userId, stream) {
                removeRemoteVideo(userId);
                
                const videoContainer = document.createElement('div');
                videoContainer.className = 'cyber-video';
                videoContainer.id = `remote-${userId}`;
                
                const videoElement = document.createElement('video');
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                videoElement.srcObject = stream;
                
                const labelElement = document.createElement('div');
                labelElement.className = 'video-label';
                labelElement.classList.add('blue-glow');
                labelElement.textContent = `Remote [${userId.slice(0, 4)}]`;
                
                const fullscreenBtn = document.createElement('div');
                fullscreenBtn.textContent = '⛶';
                fullscreenBtn.style.position = 'absolute';
                fullscreenBtn.style.top = '5px';
                fullscreenBtn.style.right = '5px';
                fullscreenBtn.style.cursor = 'pointer';
                fullscreenBtn.style.zIndex = '10';
                fullscreenBtn.style.backgroundColor = 'rgba(0,0,0,0.5)';
                fullscreenBtn.style.padding = '2px 5px';
                fullscreenBtn.style.borderRadius = '3px';
                fullscreenBtn.addEventListener('click', () => toggleFullscreen(videoElement, 'remote'));
                
                videoContainer.appendChild(videoElement);
                videoContainer.appendChild(labelElement);
                videoContainer.appendChild(fullscreenBtn);
                videoWall.appendChild(videoContainer);
            }

            // Supprimer une vidéo distante
            function removeRemoteVideo(userId) {
                const existingVideo = document.getElementById(`remote-${userId}`);
                if (existingVideo) {
                    existingVideo.remove();
                    delete remoteStreams[userId];
                }
            }

            // Envoyer un message
            function sendMessage() {
                const text = messageInput.value.trim();
                if (text && websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'text_message',
                        data: { text }
                    }));
                    messageInput.value = '';
                }
            }

            // Gestion des salles
            roomTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.dataset.room === currentRoom) return;
                    
                    roomTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentRoom = tab.dataset.room;
                    updateConnectionInfo();
                    
                    websocket.send(JSON.stringify({
                        type: 'join_room',
                        data: { room_id: currentRoom }
                    }));
                    
                    messagesContainer.innerHTML = '';
                    addSystemMessage(`Vous avez rejoint la salle ${currentRoom}`, new Date().toLocaleTimeString());
                });
            });

            // Créer une nouvelle salle
            createRoomBtn.addEventListener('click', () => {
                const roomName = newRoomInput.value.trim();
                if (roomName && !document.querySelector(`.room-tab[data-room="${roomName}"]`)) {
                    const newTab = document.createElement('div');
                    newTab.className = 'room-tab';
                    newTab.dataset.room = roomName;
                    newTab.textContent = roomName.toUpperCase();
                    newTab.addEventListener('click', () => {
                        roomTabs.forEach(t => t.classList.remove('active'));
                        newTab.classList.add('active');
                        currentRoom = roomName;
                        updateConnectionInfo();
                        websocket.send(JSON.stringify({
                            type: 'join_room',
                            data: { room_id: currentRoom }
                        }));
                        messagesContainer.innerHTML = '';
                        addSystemMessage(`Vous avez rejoint la salle ${currentRoom}`, new Date().toLocaleTimeString());
                    });
                    createRoomBtn.parentNode.insertBefore(newTab, createRoomBtn);
                    newRoomInput.value = '';
                }
            });

            // Gestion des émoticônes
            emoteBtn.addEventListener('click', () => {
                emotePicker.style.display = emotePicker.style.display === 'flex' ? 'none' : 'flex';
            });

            document.querySelectorAll('.emote-option').forEach(option => {
                option.addEventListener('click', () => {
                    const emote = option.dataset.emote;
                    messageInput.value += ` ${emote} `;
                    emotePicker.style.display = 'none';
                    messageInput.focus();
                });
            });

            // Gestion de la radio
            const radioToggleBtn = document.createElement('button');
            radioToggleBtn.className = 'cyber-btn';
            radioToggleBtn.textContent = 'RADIO';
            radioToggleBtn.style.marginTop = 'auto';
            radioToggleBtn.style.marginBottom = '10px';
            radioToggleBtn.addEventListener('click', () => {
                radioPanel.style.display = radioPanel.style.display === 'none' ? 'block' : 'none';
            });
            document.getElementById('connection-info').appendChild(radioToggleBtn);

            radioPlayBtn.addEventListener('click', () => {
                const stationUrl = radioStation.value;
                if (stationUrl) {
                    radioPlayer.src = stationUrl;
                    radioPlayer.play()
                        .then(() => {
                            radioStatus.textContent = `En écoute: ${radioStation.options[radioStation.selectedIndex].text}`;
                            radioStatus.classList.add('playing');
                            radioPlayBtn.textContent = "▶ EN COURS";
                            radioPlayBtn.classList.add('pink-glow');
                        })
                        .catch(e => {
                            radioStatus.textContent = "Erreur de lecture";
                            console.error("Erreur radio:", e);
                        });
                }
            });

            radioStopBtn.addEventListener('click', () => {
                radioPlayer.pause();
                radioPlayer.src = '';
                radioStatus.textContent = "Arrêté";
                radioStatus.classList.remove('playing');
                radioPlayBtn.textContent = "▶ PLAY";
                radioPlayBtn.classList.remove('pink-glow');
            });

            radioStation.addEventListener('change', () => {
                if (radioPlayer.src && !radioPlayer.paused) {
                    radioPlayBtn.click();
                }
            });

            // Fonctions pour gérer les flux M3U/M3U8
            function playM3uStream() {
                const url = m3uUrlInput.value.trim();
                if (!url) return;

                // Arrêter la radio si elle joue
                radioStopBtn.click();

                // Vérifier si HLS.js est disponible
                if (Hls.isSupported()) {
                    stopM3uStream();
                    
                    hls = new Hls({
                        maxBufferLength: 30,
                        maxMaxBufferLength: 600,
                        maxBufferSize: 60 * 1000 * 1000,
                        maxBufferHole: 0.5,
                        lowLatencyMode: false,
                        enableWorker: true,
                        startLevel: -1,
                    });

                    hls.loadSource(url);
                    hls.attachMedia(m3uPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        m3uPlayer.play().catch(e => {
                            m3uStatus.textContent = "Erreur de lecture: " + e.message;
                            console.error("Erreur lecture M3U:", e);
                        });
                    });

                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    m3uStatus.textContent = "Erreur réseau";
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    m3uStatus.textContent = "Erreur média";
                                    break;
                                default:
                                    m3uStatus.textContent = "Erreur de lecture";
                            }
                            stopM3uStream();
                        }
                    });

                    m3uPlayerContainer.style.display = 'block';
                    m3uStatus.textContent = "Lecture en cours...";
                    m3uPlayBtn.textContent = "▶ EN COURS";
                    m3uPlayBtn.classList.add('pink-glow');
                } else if (m3uPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    // Support natif pour Safari
                    m3uPlayer.src = url;
                    m3uPlayer.addEventListener('loadedmetadata', () => {
                        m3uPlayer.play().catch(e => {
                            m3uStatus.textContent = "Erreur de lecture: " + e.message;
                            console.error("Erreur lecture M3U:", e);
                        });
                    });
                    
                    m3uPlayerContainer.style.display = 'block';
                    m3uStatus.textContent = "Lecture en cours...";
                    m3uPlayBtn.textContent = "▶ EN COURS";
                    m3uPlayBtn.classList.add('pink-glow');
                } else {
                    m3uStatus.textContent = "Format non supporté par votre navigateur";
                }
            }

            function stopM3uStream() {
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                
                m3uPlayer.pause();
                m3uPlayer.src = '';
                m3uPlayerContainer.style.display = 'none';
                m3uStatus.textContent = "Arrêté";
                m3uPlayBtn.textContent = "▶ LIRE";
                m3uPlayBtn.classList.remove('pink-glow');
            }

            // Événements pour le lecteur M3U
            m3uPlayBtn.addEventListener('click', playM3uStream);
            m3uStopBtn.addEventListener('click', stopM3uStream);

            // Fonctions pour gérer les appels vidéo
            callBtn.addEventListener('click', () => {
                if (callInProgress) return;
                
                callUserList.innerHTML = '';
                const users = Array.from(document.querySelectorAll('#user-list .cyber-user'))
                    .filter(user => !user.textContent.includes(username));
                
                if (users.length === 0) {
                    addSystemMessage("Aucun utilisateur disponible pour un appel", new Date().toLocaleTimeString());
                    return;
                }
                
                users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'cyber-user';
                    userElement.style.cursor = 'pointer';
                    userElement.style.margin = '5px 0';
                    userElement.textContent = user.textContent.split(' ')[0];
                    userElement.dataset.userId = user.textContent.split(' ')[0];
                    
                    userElement.addEventListener('click', () => {
                        document.querySelectorAll('#call-user-list .cyber-user').forEach(u => 
                            u.classList.remove('selected'));
                        userElement.classList.add('selected');
                        callTarget = userElement.dataset.userId;
                    });
                    
                    callUserList.appendChild(userElement);
                });
                
                callModal.style.display = 'flex';
            });

            // Démarrer un appel
            callStartBtn.addEventListener('click', async () => {
                if (!callTarget) {
                    addSystemMessage("Veuillez sélectionner un utilisateur", new Date().toLocaleTimeString());
                    return;
                }
                
                try {
                    // Démarrer la caméra locale
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true,
                        audio: true
                    });
                    
                    callStream = stream;
                    localCallVideo.srcObject = stream;
                    callUsername.textContent = callTarget;
                    callInProgress = true;
                    callBtn.style.display = 'none';
                    endCallBtn.style.display = 'block';
                    callModal.style.display = 'none';
                    callContainer.style.display = 'flex';
                    
                    // Envoyer une demande d'appel
                    websocket.send(JSON.stringify({
                        type: 'call_request',
                        data: {
                            target: callTarget,
                            action: 'start'
                        }
                    }));
                    
                    addSystemMessage(`Appel en cours avec ${callTarget}`, new Date().toLocaleTimeString());
                } catch (error) {
                    console.error("Erreur démarrage appel:", error);
                    addSystemMessage("Erreur lors du démarrage de l'appel", new Date().toLocaleTimeString());
                }
            });

            // Gestion des boutons d'appel
            endCallBtn.addEventListener('click', endCall);
            endCallButton.addEventListener('click', endCall);

            toggleMicBtn.addEventListener('click', () => {
                if (!callStream) return;
                const audioTracks = callStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    micEnabled = !micEnabled;
                    audioTracks[0].enabled = micEnabled;
                    toggleMicBtn.style.borderColor = micEnabled ? 'var(--neon-blue)' : '#ff0000';
                    toggleMicBtn.style.color = micEnabled ? 'white' : '#ff0000';
                }
            });

            toggleCamBtn.addEventListener('click', () => {
                if (!callStream) return;
                const videoTracks = callStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    camEnabled = !camEnabled;
                    videoTracks[0].enabled = camEnabled;
                    toggleCamBtn.style.borderColor = camEnabled ? 'var(--neon-blue)' : '#ff0000';
                    toggleCamBtn.style.color = camEnabled ? 'white' : '#ff0000';
                    localCallVideo.style.opacity = camEnabled ? '1' : '0.5';
                }
            });

            function endCall() {
                if (callStream) {
                    callStream.getTracks().forEach(track => track.stop());
                    localCallVideo.srcObject = null;
                    remoteCallVideo.srcObject = null;
                    callStream = null;
                }
                
                if (callTarget) {
                    websocket.send(JSON.stringify({
                        type: 'call_request',
                        data: {
                            target: callTarget,
                            action: 'end'
                        }
                    }));
                }
                
                callInProgress = false;
                callTarget = null;
                callBtn.style.display = 'block';
                endCallBtn.style.display = 'none';
                callContainer.style.display = 'none';
                
                // Réinitialiser les boutons
                toggleMicBtn.style.borderColor = 'var(--neon-blue)';
                toggleMicBtn.style.color = 'white';
                toggleCamBtn.style.borderColor = 'var(--neon-blue)';
                toggleCamBtn.style.color = 'white';
                localCallVideo.style.opacity = '1';
                
                addSystemMessage("Appel terminé", new Date().toLocaleTimeString());
            }

            // Gestion des demandes d'appel entrantes
            function handleIncomingCall(from, action) {
                if (action === 'start') {
                    if (callInProgress) {
                        // Refuser l'appel si déjà en cours
                        websocket.send(JSON.stringify({
                            type: 'call_response',
                            data: {
                                target: from,
                                accepted: false,
                                reason: 'busy'
                            }
                        }));
                        return;
                    }
                    
                    const accept = confirm(`${from} vous appelle. Accepter?`);
                    if (accept) {
                        callTarget = from;
                        callInProgress = true;
                        callBtn.style.display = 'none';
                        endCallBtn.style.display = 'block';
                        callUsername.textContent = from;
                        
                        // Démarrer la caméra locale
                        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                            .then(stream => {
                                callStream = stream;
                                localCallVideo.srcObject = stream;
                                callContainer.style.display = 'flex';
                                
                                websocket.send(JSON.stringify({
                                    type: 'call_response',
                                    data: {
                                        target: from,
                                        accepted: true
                                    }
                                }));
                                
                                addSystemMessage(`Appel en cours avec ${from}`, new Date().toLocaleTimeString());
                            })
                            .catch(error => {
                                console.error("Erreur démarrage appel:", error);
                                websocket.send(JSON.stringify({
                                    type: 'call_response',
                                    data: {
                                        target: from,
                                        accepted: false,
                                        reason: 'error'
                                    }
                                }));
                            });
                    } else {
                        websocket.send(JSON.stringify({
                            type: 'call_response',
                            data: {
                                target: from,
                                accepted: false,
                                reason: 'declined'
                            }
                        }));
                    }
                } else if (action === 'end') {
                    if (callInProgress && callTarget === from) {
                        endCall();
                        addSystemMessage(`${from} a terminé l'appel`, new Date().toLocaleTimeString());
                    }
                }
            }

            // Gestion des réponses aux appels
            function handleCallResponse(from, accepted, reason) {
                if (!callInProgress || callTarget !== from) return;
                
                if (accepted) {
                    addSystemMessage(`${from} a accepté votre appel`, new Date().toLocaleTimeString());
                } else {
                    endCall();
                    let message = `${from} a refusé votre appel`;
                    if (reason === 'busy') message = `${from} est déjà en appel`;
                    else if (reason === 'error') message = `Erreur lors de l'acceptation de l'appel par ${from}`;
                    
                    addSystemMessage(message, new Date().toLocaleTimeString());
                }
            }

            // Événements
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            camBtn.addEventListener('click', toggleCamera);
            screenBtn.addEventListener('click', toggleScreenShare);

            // Nettoyage avant déchargement
            window.addEventListener('beforeunload', () => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.close();
                }
                
                Object.keys(localStreams).forEach(type => {
                    stopStream(type);
                });
                
                radioStopBtn.click();
                stopM3uStream();
            });

            // Adaptation dynamique
            window.addEventListener('resize', () => {
                const videoElements = document.querySelectorAll('.cyber-video video');
                videoElements.forEach(video => {
                    if (video.srcObject) {
                        video.srcObject.getVideoTracks().forEach(track => {
                            const constraints = track.getConstraints();
                            if (constraints.width && constraints.height) {
                                track.applyConstraints({
                                    width: window.innerWidth < 768 ? { ideal: 640 } : { ideal: 1280 },
                                    height: window.innerWidth < 768 ? { ideal: 480 } : { ideal: 720 }
                                });
                            }
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>